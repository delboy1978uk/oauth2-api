#!/usr/bin/env php
<?php

define('APPLICATION_PATH', realpath('..'));

require_once '../vendor/autoload.php';

use BoneMvc\ConsoleApplication;
use Del\Console\UserCommand;
use Del\Common\ContainerService;
use Del\Common\Config\DbCredentials;
use OAuth\Command\ClientCommand;
use Del\UserPackage;
use OAuth\OAuthPackage;

// Set up the Dependency Injection container
require_once APPLICATION_PATH . '/config/config.php';

if (file_exists( APPLICATION_PATH . '/config/config.dev.php'))
{
    $config = array_merge($config, require_once ( APPLICATION_PATH . '/config/config.dev.php'));
}

$containerSvc = ContainerService::getInstance();

$dbname = $config['db']['database'];
$user = $config['db']['user'];
$pass = $config['db']['pass'];
$host = $config['db']['host'];

$credentials = new DbCredentials();
$credentials->setUser($user)
    ->setPassword($pass)
    ->setDatabase($dbname)
    ->setHost($host);

$svc = ContainerService::getInstance();
$svc->setDbCredentials($credentials);
$svc->setProxyPath(realpath(APPLICATION_PATH.'/data/proxies'));
$svc->registerToContainer(new UserPackage());
$svc->registerToContainer(new OAuthPackage());
$container = $svc->getContainer();

// Set up the application
$app = new ConsoleApplication();

$userCommand = new UserCommand();
$clientCommand = new ClientCommand($container['oauth.service.client'], $container['service.user']);

$app->add($userCommand);
$app->add($clientCommand);

$app->run();
